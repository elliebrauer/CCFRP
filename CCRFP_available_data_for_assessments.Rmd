---
title: "California Collaborative Fisheries Research Program"
subtitle: "Data availability for stock assessments"
author: "Melissa H. Monk"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2: 
    keep_tex: true
    keep_md: true
toc: false
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{placeins}
always_allow_html: true
---


```{r load-packages, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(devtools)
library(dplyr)
library(ggplot2)
library(ggridges)
library(stringr)
library(tidyr)
library(purrr)
library(unikn)
library(viridis)
library(kableExtra)
library(knitr)
library(forcats)
```

```{r setup, echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, cache = TRUE}
knitr::opts_chunk$set(echo = FALSE)

setwd("C:/GitHub/CCFRP")

#-------------------------------------------------------------------------------
# Read in data and basic cleanup
load("CCFRP_cleanedup.RData")
#-------------------------------------------------------------------------------

Assess2023 <- data.frame(
  Species = c(
    "Black Rockfish",
    "Copper Rockfish",
    "Quillback Rockfish",
    "Yellowtail Rockfish"
  ),
  AssessGroup = "Assess2023"
)

AssessTop30 <- data.frame(
  Species = c(
    "Brown Rockfish",
    "Treefish",
    "Blue Rockfish",
    "Deacon Rockfish",
    "Canary Rockfish",
    "Vermilion Rockfish",
    "China Rockfish",
    "Olive Rockfish",
    "Grass Rockfish"
  ),
  AssessGroup = "AssessTop30"
)
SpeciesOfInterest <- rbind(Assess2023, AssessTop30)
```

```{r echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, cache = TRUE}
# Reorder university so that the table has years in order - not north to south,
# but this is a kable issue - if you put HSU first, the first year they sampled,
# 2017, is first in the table

#remove tilde from Ano, now causing issues
#dat_final$Name = str_replace(dat_final$Name,"A単o Nuevo", "Ano Nuevo")

dat_final <- dat_final %>%
  ungroup() %>%
  dplyr::mutate(Monitoring.Group = factor(Monitoring.Group, levels = c(
    "MLML",
    "Cal Poly",
    "HSU", "BML",
    "UCSB", "SIO"
  ))) %>%
  dplyr::mutate(`Monitoring Group` = Monitoring.Group) %>%
  dplyr::mutate(`Monitoring Group` = recode(`Monitoring Group`,
    "HSU" = "Cal Poly Humboldt",
    "BML" = "Bodega Marine Lab",
    "MLML" = "Moss Landing Marine Lab",
    "Cal Poly" = "Cal Poly SLO",
    "UCSB" = "UC Santa Barbara",
    "SIO" = "Scripps Institute Ocean."
  )) %>%
  dplyr::mutate(Monitoring.Group = recode(Monitoring.Group,
    "HSU" = "Humboldt",
    "BML" = "Bodega",
    "MLML" = "Moss Landing",
    "Cal Poly" = "Cal Poly",
    "UCSB" = "UCSB",
    "SIO" = "Scripps"
  )) %>%
#  dplyr::mutate(Name = factor(Name)) %>%
# dplyr:: mutate(Name = dplyr::recode(Name,
#                       "A単o Nuevo" = "Ano Nuevo")) %>%
  dplyr::mutate(Name = factor(Name, levels = c(
    "South Cape Mendocino", "Ten Mile",
    "Stewarts Point", "Bodega Head",
    "A単o Nuevo", "Point Lobos",
    "Piedras Blancas", "Point Buchon",
    "Carrington Point", "Anacapa Island",
    "Swamis", "South La Jolla"
  ))) %>%
  dplyr::mutate(Name = recode(Name,
                              "A単o Nuevo" = "Ano Nuevo"))

# Change the levels of monitoring groups from north to south - didn't do before because of weird tables stuff
# Reorder the factor levels north to south
dat_final <- dat_final %>%
  mutate(Monitoring.Group = fct_relevel(Monitoring.Group, "Moss Landing", after = 3)) %>%
  mutate(Monitoring.Group = fct_relevel(Monitoring.Group, "Cal Poly", after = 3))

# Just drift info
drifts_final <- dat_final %>%
  ungroup() %>%
  select(
    Drift.ID, Trip.ID, Grid.Cell.ID, SITE, Name, MPA.Designation, YEAR, Month, 
    Day, Start.Depth..ft., End.Depth..ft., Monitoring.Group,
    StartGISDepth2mRes_ft, StartGISDepth90mRes_ft, EndGISDepth2mRes_ft, 
    EndGISDepth90mRes_ft
  ) %>%
  unique()

# lengths and then join to drift info
species_lengths <- catches %>%
  filter(!is.na(Length..cm.))
species_lengths <- inner_join(species_lengths, drifts_final)
```

# Summary
This document summarizes the data from the California Collaborative 
Fisheries Research Program (CCFRP) as well as the available data for the four 
species proposed for stock assessments in 2023, black rockfish (*Sebastes melanops*),
copper rockfish (*S. caurinus*), quillback rockfish (*S. maliger*), and 
yellowtail rockfish (*S. flavidus*) . 

# Survey Background
The 1999 Marine Life Protection Act resulted in the creation of a network of 
Marine Protected Areas (MPAs) along California's coast. The state of California
designated both State Marine Reserves (SMRs) and State Marine Recreational 
Management areas (SMCAs). The SMRs prohibit all recreational and commercial take 
and SMCAs allow some recreational and/or commercial take that varies by SMCA. 
A number of MPAs have both an SMR and SMCA, of which the SMR is closer to shore.
The California Collaborative Fisheries Research Program, 
[CCFRP](https://www.mlml.calstate.edu/ccfrp/), 
is a fishery-independent hook-and-line survey designed to monitor nearshore fish 
populations at a series of sampling locations both inside and adjacent to 
California's network of MPAs [@Wendt2009; @Starr2015]. The CCFRP survey began in 
2007 in collaboration with NMFS scientists and the fishing community.  The core 
area of the survey includes A&ntilde;o Nuevo SMR and Point Lobos SMR sampled by 
San Jose State University Moss Landing Marine Lab, and Point Buchon SMR 
and Piedras Blancas SMR sampled by California Polytechnic University 
San Luis Obispo (Figure \@ref(fig:fig-mpa-map)). In 2017, CCFRP expanded within California to 
include four additional partners, Cal Poly Humboldt (formerly Humboldt State 
University), University of California Davis' Bodega Marine Lab, University 
of California Santa Barbara and Scripps Institute of Oceanography. 
The CCFRP now monitors 12 MPA and reference area pairs (Table \@ref(tab:monitoring)). 
Cal Poly Humboldt samples the furthest north sites, which are still south of Cape 
Mendocino.  There are three nearshore SMCAs north of the South Cape Mendocino that 
were not selected for CCFRP due to historical sampling  at the other two sites and 
the SMR tier.



The CCFRP survey design is consistent across all partners. Each MPA and reference 
area consists of a number 500 x 500 m cells that were selected because the contained 
appropriate rockfish habitat. The survey is restricted to 120 feet to reduce 
potential effects of barotrauma since the survey was designed as a capture 
and release survey, with a sub-study tag/recapture program. On any given survey 
day site cells are randomly selected within a stratum (MPA and/or reference cells).  
Commercial passenger fishing vessels (CPFVs) are chartered for the survey and 
the captain is allowed to search within the cell for a fishing location.  During 
a sampling event, each cell is fished for a total of 30-45 minutes by volunteer 
anglers. Volunteer anglers are allowed to reel up their lines at any time during a 
fishing drop if they think they've hooked fish. Anglers can then re-bait and 
continue fishing until the the drop is complete. Each fish encountered 
can be linked back to an angler. Each anglers fishes one line, with two hooks. 
The jig and bait is assigned to each angler, but an angler may fish with a personal 
fishing rod.

All fish encountered are measured to the nearest centimeter (fork length).  
A total of xxxx fish were tagged since 2007, and the majority of fish are 
released or descended to depth. Starting in 2017, at the request of NMFS, some 
fish are retained to collect otoliths and fin clips that provide needed 
biological information for nearshore species.  In 2022, the goal will be to collect 
50-100 otoliths for commonly enountered species for use in the 2023 stock assessments.

Due to the nature of the fishery in northern California, Humboldt conducts sampling aboard 6-pack 
vessels, and therefore has fewer total angler hours per year compared to the 
other regions ().  The COVID-19 pandemic also affect the survey effort, but all 
partners were able to conduct sampling in 2000 and 2001.  





```{r, fig-mpa-map, echo = FALSE, fig.cap = "Map of the State Marine Reserves (SMRs) monitored by the CCFRP program."}
knitr::include_graphics('MPA_map.pdf')
```



# Available Samples

From 2007-2021 a total of `r length(unique(drifts_all$Trip.ID))` fishing trips 
were taken, consisting of `r dim(drifts_all)[1]` fishing drops. When the CCFRP 
expanded in 2017, some MPAs/sites were fished in only one or two years during an 
exploratory phase.  These included Laguna Beach, the southeast Farallon Islands, 
Point Conception and Trinidad, which were excluded from this summary since we 
would not include them in a stock assessment. 
Fishing drops that drifted outside a cell were also excluded.  These site filter 
result in an available `r length(unique(dat$Drift.ID))`. The final filter removed 
drifts within a cell that were not fished for at least ten minutes within a sampling 
occasion, resulting in a total of `r length(unique(dat_final$Drift.ID))` fishing 
drops available for analyses for stock assessments.

Cal Poly Humboldt (formerly Humboldt State University) does not collect depth 
information at each fishing drop.  Depths 
were interpreted from the California Seafloor Mapping Project (CSMP) 2 m bathymetry 
for the start and end locations of each fishing drop. There were also xx fishing 
drops with missing depth data that were added based on the bathymetry.

```{r monitoring, echo = FALSE, warning = FALSE, message = FALSE}
knitr::kable(
  booktabs = T,
  caption = "Monitoring groups and the associated MPAs they sample. The abbreviated names will be 
  used throughout most of the tables in this document",
  dat_final %>%
    select(`Monitoring Group`, Monitoring.Group, Name) %>%
    unique() %>%
    arrange(Monitoring.Group, Name) %>%
    rename('Abbreviated Name' = Monitoring.Group,
           'MPA' = Name)
) %>%
  kable_styling(latex_options = "striped")
```

\newpage

```{r anghrs, echo = FALSE, warning = FALSE, message = FALSE}
# Total effort by year among the programs
knitr::kable(
  booktabs = T,
  caption = "Total angler hours by institution summed across all active years.",
  dat_final %>%
    ungroup() %>%
    select(Drift.ID, YEAR, Effort, Total...Anglers.Fishing, Monitoring.Group, Name) %>%
    unique() %>%
    select(Monitoring.Group, YEAR, Effort) %>%
    group_by(Monitoring.Group, YEAR) %>%
    summarise(Total_AnglerHours = round(sum(Effort), 0)) %>%
    pivot_wider(id_cols = YEAR, names_from = Monitoring.Group, values_from = Total_AnglerHours, values_fill = 0) %>%
    arrange(YEAR)
) %>%
  kable_styling(latex_options = "striped") %>%
  column_spec(2:7, width = "6em")
```



```{r fishingdrops, echo = FALSE, warning = FALSE, message = FALSE}
# Number of drift within/outside each mpa by year
knitr::kable(
  booktabs = T,
  caption = "Total number of fishing drops by year at each monitored site in the reference areas and inside the MPAs, in parentheses.",
  dat_final %>%
    select(Drift.ID, YEAR, SITE, Name) %>%
    unique() %>%
    group_by(Name, SITE, YEAR) %>%
    tally() %>%
    pivot_wider(id_cols = c(YEAR, Name), names_from = SITE, values_from = n) %>%
    mutate(Samples = paste0(REF, "(", MPA, ")")) %>%
    select(YEAR, Name, Samples) %>%
    pivot_wider(id_cols = YEAR, names_from = Name, values_from = Samples, values_fill = '-') %>%
    arrange(YEAR)
) %>%
  add_header_above(c(" ", "Cal Poly Humboldt" = 2, "Bodega Marine Lab" = 2, 
                   "Moss Landing" = 2, "Cal Poly SLO" = 2, 
                   "UC Santa Barbara" = 2, "Scripps" = 2))  %>%
  kable_styling(latex_options = "striped") %>%
  column_spec(2, width = "1.7cm") %>%
  column_spec(3:12, width = "1.5cm") %>%
   landscape()
```

\FloatBarrier
\newpage


# Species information

We explored data availability for candidate species for the 2023 stock assessment 
cycle as well as for any other species within the top 30 rockfish species in the 
Stock Assessment Prioritiziation spreadsheet provided by the NWFSC. Only one rockfish 
species within the top 30 species was never observed by observed by CCFRP, . 
Data summaries are presented for the other 13 species.

Species without a positive identification, e.g., blue and deacon rockfish or 
yellowtail and olive rockfish, were excluded.


```{r totalfishbygroup, echo = FALSE, warning = FALSE, message = FALSE}
# Total number of fish encountered by monitoring group
knitr::kable(
  booktabs = T,
  caption = "Total number of fish encountered by each monitoring group.",
  dat_final %>%
    filter(Common.Name %in% SpeciesOfInterest$Species) %>%
    group_by(Common.Name, Monitoring.Group) %>%
    summarise(total = sum(n)) %>%
    pivot_wider(id_cols = Common.Name, names_from = Monitoring.Group, values_from = total, values_fill = 0)
) %>%
  kable_styling(latex_options = "striped")
```  

```{r echo = FALSE, include = FALSE, warning = FALSE, message = FALSE}

# Percent positive drifts at each MPA by year
drifts_by_MPA <- dat_final %>%
  select(Drift.ID, YEAR, Monitoring.Group, Name) %>%
  unique() %>%
  group_by(Name, YEAR) %>%
  summarise(tot_drifts = n())
```

```{r results = 'asis',warning = FALSE, message = FALSE}
# calculate the number of positive drifts by each of the 2023 assess species
for (i in 1:length(SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"])) {
  pos_drifts <- dat_final %>%
    filter(Common.Name %in% SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"][i]) %>%
    select(Drift.ID, YEAR, Monitoring.Group, Name) %>%
    unique() %>%
    group_by(Name, YEAR) %>%
    summarise(tot_pos_drifts = n())

  print(knitr::kable(
    booktabs = T,
    caption = paste0(
      "Percent of drifts with encounters of ",
      SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"][i],
      " in each at each monitoring location and yerar."
    ),
    left_join(drifts_by_MPA, pos_drifts) %>%
      mutate(percent_pos = scales::percent(tot_pos_drifts / tot_drifts, accuracy = 2)) %>%
      pivot_wider(id_cols = YEAR, names_from = Name, values_from = percent_pos, values_fill = "-") %>%
      replace(is.na(.), "-") %>%
      arrange(YEAR)
  ) %>%
    kable_styling(latex_options = "striped") %>%
    column_spec(2, width = "1.7cm") %>%
    column_spec(3:12, width = "1.2cm") %>%
    landscape()
  )
  cat("\n\n<!-- -->\n\n")
}

```


\FloatBarrier


# Length information

The CCFRP measures every fish to the nearest centimeter and distributions of the lengths
inside and outside the MPAs by MPA and species are in Figures xxxx.  Length data were 
filtered to the drifts included in the final data set.


\FloatBarrier

```{r , warning = FALSE, message = FALSE, echo=FALSE}
#"Frequency of fork length (cm) for inside each MPA (MPA) and outside at reference areas (REF).",

spp_to_plot <- SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"]

 plot_list <- purrr::map(.x = spp_to_plot,
                        .f = ~{
                             species_lengths %>%
                             dplyr::filter(Common.Name == .x) %>%
     ggplot(aes(x = Length..cm., colour = SITE)) +
     geom_histogram(aes(y = ..density..), alpha = 0.7, binwidth = 2, fill = "white") +
     scale_y_continuous(labels = scales::percent_format()) +
     facet_wrap(~Name, ncol = 3) +
     scale_color_brewer(palette = "Dark2") +
    labs(
      x = "Fork length (cm)",
      y = "Number of fish",
      title = .x
  ) +
    theme(legend.title = element_blank())
})

names(plot_list) = spp_to_plot
 
```


```{r fig-lengths, fig.cap = paste("Percent of",names(plot_list), "by 2 cm fork length bins encountered inside each MPA and outside at reference areas (REF)."), echo=FALSE, results = "asis"}

for(plots in plot_list) {
     print(plots)
    cat('\n\n')
}
#fig.cap = "Percent of fish in 2 cm fork length bins inside each MPA and outside at reference areas (REF)."
#eval.after = "fig.cap",warning = FALSE, message = FALSE, echo = FALSE,
```

# Available Otoliths
The number of otoliths collected by university partner and year


\FloatBarrier

```{r otoliths, results = 'asis',warning = FALSE, message = FALSE}
knitr::kable(
  booktabs = T,
  caption = "Total number of fish retained by monitoring group and year.",
   catches %>%
   filter(Retained == 'TRUE') %>%
   left_join(., drifts_final) %>%
    group_by(Common.Name, Monitoring.Group) %>%
    tally() %>%
    pivot_wider(id_cols = Common.Name, names_from = Monitoring.Group, values_from = n, values_fill = 0)
) %>%
  kable_styling(latex_options = "striped")

```

\clearpage
\newpage
