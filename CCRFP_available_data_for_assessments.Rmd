---
title: "California Collaborative Fisheries Research Program"
subtitle: "Data availability for stock assessments"
author: "Melissa H. Monk"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2: 
    keep_tex: true
    keep_md: true
toc: false
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{placeins}
always_allow_html: true
---


```{r load-packages, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(eval.after = "fig.cap")
library(devtools)
library(dplyr)
library(ggplot2)
library(ggridges)
library(stringr)
library(tidyr)
library(purrr)
library(unikn)
library(viridis)
library(kableExtra)
library(knitr)
library(forcats)
```

```{r setup, echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, cache = TRUE}
knitr::opts_chunk$set(echo = FALSE)

setwd("C:/GitHub/CCFRP")

#-------------------------------------------------------------------------------
# Read in data and basic cleanup
load("CCFRP_cleanedup.RData")
#-------------------------------------------------------------------------------

Assess2023 <- data.frame(
  Species = c(
    "Black Rockfish",
    "Copper Rockfish",
    "Quillback Rockfish",
    "Yellowtail Rockfish"
  ),
  AssessGroup = "Assess2023"
)

AssessTop30 <- data.frame(
  Species = c(
    "Brown Rockfish",
    "Treefish",
    "Blue Rockfish",
    "Deacon Rockfish",
    "Canary Rockfish",
    "Vermilion Rockfish",
    "China Rockfish",
    "Olive Rockfish",
    "Grass Rockfish"
  ),
  AssessGroup = "AssessTop30"
)
SpeciesOfInterest <- rbind(Assess2023, AssessTop30)
```

```{r echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, cache = TRUE}
# Reorder university so that the table has years in order - not morth to south,
# but this is a kable issue - if you put HSU first, the first year they sampled,
# 2017, is first in the table
dat_final <- dat_final %>%
  ungroup() %>%
  mutate(Monitoring.Group = factor(Monitoring.Group, levels = c(
    "MLML",
    "Cal Poly",
    "HSU", "BML",
    "UCSB", "SIO"
  ))) %>%
  mutate(`Monitoring Group` = Monitoring.Group) %>%
  mutate(`Monitoring Group` = recode(`Monitoring Group`,
    "HSU" = "Cal Poly Humboldt",
    "BML" = "Bodega Marine Lab",
    "MLML" = "Moss Landing Marine Lab",
    "Cal Poly" = "Cal Poly SLO",
    "UCSB" = "UC Santa Barbara",
    "SIO" = "Scripps Institute Ocean."
  )) %>%
  mutate(Monitoring.Group = recode(Monitoring.Group,
    "HSU" = "Humboldt",
    "BML" = "Bodega",
    "MLML" = "Moss Landing",
    "Cal Poly" = "Cal Poly",
    "UCSB" = "UCSB",
    "SIO" = "Scripps"
  )) %>%
  mutate(Name = factor(Name, levels = c(
    "South Cape Mendocino", "Ten Mile",
    "Stewarts Point", "Bodega Head",
    "AÃ±o Nuevo", "Point Lobos",
    "Piedras Blancas", "Point Buchon",
    "Carrington Point", "Anacapa Island",
    "Swamis", "South La Jolla"
  )))

# Change the levels of monitoring groups from north to south - didn't do before because of weird tables stuff
# Reorder the factor levels north to south
dat_final <- dat_final %>%
  mutate(Monitoring.Group = fct_relevel(Monitoring.Group, "Moss Landing", after = 3)) %>%
  mutate(Monitoring.Group = fct_relevel(Monitoring.Group, "Cal Poly", after = 3))

# Just drift info
drifts_final <- dat_final %>%
  ungroup() %>%
  select(
    Drift.ID, Trip.ID, Grid.Cell.ID, SITE, Name, MPA.Designation, YEAR, Month, Day, Start.Depth..ft., End.Depth..ft.,
    StartGISDepth2mRes_ft, StartGISDepth90mRes_ft, EndGISDepth2mRes_ft, EndGISDepth90mRes_ft
  ) %>%
  unique()

# lengths and then join to drift info
species_lengths <- catches %>%
  filter(!is.na(Length..cm.))
species_lengths <- inner_join(species_lengths, drifts_final)
```

# CCFRP Background
The California Collaborative Fisheries Research Program, 
[CCFRP](https://www.mlml.calstate.edu/ccfrp/), 
is a fishery-independent hook-and-line survey designed to monitor nearshore fish 
populations at a series of sampling 
locations both inside and adjacent to California's netowrk of Marine Protect Areas
(MPAs) [@Wendt2009; @Starr2015].  The CCFRP survey began in 2007 in collaboration 
with NMFS scientists and the fishing community.  The core area of the survey includes 
A&ntilde;o Nuevo and Point Lobos sampled by San Jose State University Moss Landing 
Marine Labs (MLML), and Point Buchon and Piedras Blancas by California Polytechnic University 
San Luis Obispo (Cal Poly). In 2017, CCFRP expanded coastwide within California, expanding 
to include four additional partners, Cal Poly Humboldt (CPH; formerly Humboldt State 
University), University of California Davis' Bodega Marine Lab (BML), University 
of California Santa Barbara (UCSB) and Scripps Institute of Oceanography (SIO), and 
xxxx monitored MPA/reference area pairs (Table xx). Cal Poly Humboldt samples the 
furthest north sites, which are still south of Cape Mendocino.  There are three 
nearshore State Marine Conservation Areas (SMCAs) north of the South Cap Mendocino 
State Marine Reserve (SMR) that is monitored. However, xxxxx

Insert a table of which universities monitor which MPAs.  Insert a maps of the 
MPAs with the cells. 


The CCFRP survey design is consistent across all partners. Each MPA and reference 
area consists of a number 500 x 500 m cells. The survey is restricted to xxxx feet 
to reduce potential effects of barotrauma since the survey was designed as a capture 
and release survey, with a sub-study tag/recapture program. On any given survey day site cells 
are randomly selected within a stratum (MPA and/or reference cells).  Commercial 
passenger fishing vessels (CPFVs) are chartered for the survey and the captain 
is allowed to search within the cell for a fishing location.  During a sampling 
event, each cell is fished for a total of 30-45 minutes by volunteer anglers. Volunteer 
anglers are allowed to reel up their lines when they believe they've hooked fish, 
re-bait and continue fishing until the the drop is complete. Each fish encountered 
can be linked back to an angler. Each anglers fishes one line, with two hooks. 
The jig and bait type may differ.....

All fish encountered are measured to the nearest centimeter (fork length).  
A total of xxxx fish were tagged since 2007, and the majority of fish are 
released or descended to depth. Starting in 2017, at the request of NMFS, some 
fish are retained to collect otoliths and fin clips that provide needed 
biological information for nearshore species.  In 2022, the goal will be to collect 
50-100 otoliths for commonly enountered species for use in the 2023 stock assessments.

Due to the nature of the fishery in northern California, Humboldt conducts sampling aboard 6-pack 
vessels, and therefore has fewer total angler hours per year compared to the 
other regions ().  The COVID-19 pandemic also affect the survey effort, but all 
partners were able to conduct sampling in 2000 and 2001.  

Tables of the number of positive drops of a species by university partner,
inside and outside the MPA

The number of otoliths collected by university partner and year


```{r, fig-mpa-map, echo = FALSE, fig.cap = "Map of the State Marine Reserves (SMRs) monitored by the CCFRP program."}
knitr::include_graphics('MPA_map.pdf')
```



# Available Samples

From 2007-2021 a total of `r length(unique(drifts_all$Trip.ID))` fishing trips 
were taken, consisting of `r dim(drifts_all)[1]` fishing drops. When the CCFRP 
expanded in 2017, some MPAs/sites were fished in only one or two years during an 
exploratory phase.  These included Laguna Beach, the southeast Farallon Islands, 
Point Conception and Trinidad, which were excluded from this summary since we 
would not include them in a stock assessment. 
Fishing drops that drifted outside a cell were also excluded.  These site filter 
result in an available `r length(unique(dat$Drift.ID))`. The final filter removed 
drifts within a cell that were not fished for at least ten minutes within a sampling 
occasion, resulting in a total of `r length(unique(dat_final$Drift.ID))` fishing 
drops available for analyses for stock assessments.

Cal Poly Humboldt (formerly Humboldt State University) does not collect depth 
information at each fishing drop.  Depths 
were interpreted from the California Seafloor Mapping Project (CSMP) 2 m bathymetry 
for the start and end locations of each fishing drop. There were also xx fishing 
drops with missing depth data that were added based on the bathymetry.

```{r monitoring, echo = FALSE, warning = FALSE, message = FALSE}
knitr::kable(
  booktabs = T,
  caption = "Monitoring groups and the associated MPAs they sample. The shorthand names will be 
  used throughout most of the tables in this document",
  dat_final %>%
    select(`Monitoring Group`, Monitoring.Group, Name) %>%
    unique() %>%
    arrange(Monitoring.Group, Name) %>%
    rename('Shorthand Name' = Monitoring.Group,
           'MPA' = Name)
) %>%
  kable_styling(latex_options = "striped")
```

\newpage

```{r anghrs, echo = FALSE, warning = FALSE, message = FALSE}
# Total effort by year among the programs
knitr::kable(
  booktabs = T,
  caption = "Total angler hours by institution summed across all active years.",
  dat_final %>%
    ungroup() %>%
    select(Drift.ID, YEAR, Effort, Total...Anglers.Fishing, Monitoring.Group, Name) %>%
    unique() %>%
    select(Monitoring.Group, YEAR, Effort) %>%
    group_by(Monitoring.Group, YEAR) %>%
    summarise(Total_AnglerHours = round(sum(Effort), 0)) %>%
    pivot_wider(id_cols = YEAR, names_from = Monitoring.Group, values_from = Total_AnglerHours, values_fill = 0) %>%
    arrange(YEAR)
) %>%
  kable_styling(latex_options = "striped") %>%
  column_spec(2:7, width = "6em")
```



```{r fishingdrops, echo = FALSE, warning = FALSE, message = FALSE}
# Number of drift within/outside each mpa by year
knitr::kable(
  booktabs = T,
  caption = "Total number of fishing drops by year at each monitored site in the reference areas and inside the MPAs, in parentheses.",
  dat_final %>%
    select(Drift.ID, YEAR, SITE, Name) %>%
    unique() %>%
    group_by(Name, SITE, YEAR) %>%
    tally() %>%
    pivot_wider(id_cols = c(YEAR, Name), names_from = SITE, values_from = n) %>%
    mutate(Samples = paste0(REF, "(", MPA, ")")) %>%
    select(YEAR, Name, Samples) %>%
    pivot_wider(id_cols = YEAR, names_from = Name, values_from = Samples, values_fill = '-') %>%
    arrange(YEAR)
) %>%
  add_header_above(c(" ", "Cal Poly Humboldt" = 2, "Bodega Marine Lab" = 2, 
                   "Moss Landing" = 2, "Cal Poly SLO" = 2, 
                   "UC Santa Barbara" = 2, "Scripps" = 2))  %>%
  kable_styling(latex_options = "striped") %>%
  column_spec(2, width = "1.7cm") %>%
  column_spec(3:12, width = "1.5cm") %>%
   landscape()
```

\FloatBarrier
\newpage


# Species information

We explored data availability for candidate species for the 2023 stock assessment 
cycle as well as for any other species within the top 30 rockfish species in the 
Stock Assessment Prioritiziation spreadsheet provided by the NWFSC. Only one rockfish 
species within the top 30 species was never observed by observed by CCFRP, . 
Data summaries are presented for the other 13 species.

Species without a positive identification, e.g., blue and deacon rockfish or 
yellowtail and olive rockfish, were excluded.


```{r totalfishbygroup, echo = FALSE, warning = FALSE, message = FALSE}
# Total number of fish encountered by monitoring group
knitr::kable(
  booktabs = T,
  caption = "Total number of fish encountered by each monitoring group.",
  dat_final %>%
    filter(Common.Name %in% SpeciesOfInterest$Species) %>%
    group_by(Common.Name, Monitoring.Group) %>%
    summarise(total = sum(n)) %>%
    pivot_wider(id_cols = Common.Name, names_from = Monitoring.Group, values_from = total, values_fill = 0)
) %>%
  kable_styling(latex_options = "striped")
```  

```{r echo = FALSE, include = FALSE, warning = FALSE, message = FALSE}

# Percent positive drifts at each MPA by year
drifts_by_MPA <- dat_final %>%
  select(Drift.ID, YEAR, Monitoring.Group, Name) %>%
  unique() %>%
  group_by(Name, YEAR) %>%
  summarise(tot_drifts = n())
```

```{r results = 'asis',warning = FALSE, message = FALSE}
# calculate the number of positive drifts by each of the 2023 assess species
for (i in 1:length(SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"])) {
  pos_drifts <- dat_final %>%
    filter(Common.Name %in% SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"][i]) %>%
    select(Drift.ID, YEAR, Monitoring.Group, Name) %>%
    unique() %>%
    group_by(Name, YEAR) %>%
    summarise(tot_pos_drifts = n())

  print(knitr::kable(
    booktabs = T,
    caption = paste0(
      "Percent of drifts with encounters of ",
      SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"][i],
      " in each at each monitoring location and yerar."
    ),
    left_join(drifts_by_MPA, pos_drifts) %>%
      mutate(percent_pos = scales::percent(tot_pos_drifts / tot_drifts, accuracy = 2)) %>%
      pivot_wider(id_cols = YEAR, names_from = Name, values_from = percent_pos, values_fill = "-") %>%
      replace(is.na(.), "-") %>%
      arrange(YEAR)
  ) %>%
    kable_styling(latex_options = "striped") %>%
    column_spec(2, width = "1.7cm") %>%
    column_spec(3:12, width = "1.2cm") %>%
    landscape()
  )
  cat("\n\n<!-- -->\n\n")
}

```


\FloatBarrier


# Length information

The CCFRP measures every fish to the nearest centimeter and distributions of the lengths
inside and outside the MPAs by MPA and species are in Figures xxxx.  Length data were 
filtered to the drifts included in the final data set.


```{r, results = "asis", eval.after='fig.cap', fig.cap = "Frequency of fork length (cm) for inside each MPA (MPA) and outside at reference areas (REF).", warning = FALSE, message = FALSE, echo=FALSE}
# calculate the number of positive drifts by each of the 2023 assess species
# paste0("Distribution of fork length for " ,SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup=="Assess2023"][i], " inside and #outside each monitored MPA."
spp_to_plot <- SpeciesOfInterest$Species[SpeciesOfInterest$AssessGroup == "Assess2023"]

plot_list <- purrr::walk(.x = spp_to_plot,
                        .f = ~{
                         print( species_lengths %>%
                             dplyr::filter(Common.Name == .x) %>%
     ggplot(aes(x = Length..cm., colour = as.factor(SITE))) +
     geom_freqpoly() +
     facet_wrap(~Name) +
     scale_color_brewer(palette = "Dark2") +
    labs(
      x = "Fork length (cm)",
      y = "Number of fish",
      title = .x
   #   caption = paste0("Frequency of fork length (cm) for ", .x, " inside each MPA (MPA) and outside at reference #areas (REF).")
    ) +
    theme(legend.title = element_blank())
)
      cat("\n\n<!-- -->\n\n")
      
})

```

```{r results = "asis", warning = FALSE, message = FALSE, echo=FALSE}
#purrr::map(plot_list, ~ plot(.x))
```




\clearpage
\newpage
