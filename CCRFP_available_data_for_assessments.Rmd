---
title: "California Collaborative Fisheries Research Program"
subtitle: "Data availability for stock assessments"
author: "Melissa H. Monk"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::pdf_document2: 
    keep_tex: true
    keep_md: true
toc: false
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{placeins}
always_allow_html: true
---


```{r load-packages, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(devtools)
library(dplyr)
library(ggplot2)
library(ggridges)
library(stringr)
library(tidyr)
library(unikn)
library(viridis)
library(kableExtra)
library(knitr)
```


#CCFRP Background
The California Collaborative Fisheries Research Program, 
[CCFRP](https://www.mlml.calstate.edu/ccfrp/), 
is a fishery-independent hook-and-line survey designed to monitor nearshore fish 
populations at a series of sampling 
locations both inside and adjacent to California's netowrk of Marine Protect Areas
(MPAs) [@Wendt2009; @Starr2015].  The CCFRP survey began in 2007 in collaboration 
with NMFS scientists and the fishing community.  The core area of the survey includes 
A&ntilde;o Nuevo and Point Lobos sampled by San Jose State University Moss Landing 
Marine Labs (MLML), and Point Buchon and Piedras Blancas by California Polytechnic University 
San Luis Obispo (Cal Poly). In 2017, CCFRP expanded coastwide within California, expanding 
to include four additional partners, Cal Poly Humboldt (CPH; formerly Humboldt State 
University), University of California Davis' Bodega Marine Lab (BML), University 
of California Santa Barbara (UCSB) and Scripps Institute of Oceanography (SIO), and 
xxxx monitored MPA/reference area pairs (Table xx).

Insert a table of which universities monitor which MPAs.  Insert a maps of the 
MPAs with the cells. 


The CCFRP survey design is consistent across all partners. Each MPA and reference 
area consists of a number 500 x 500 m cells. The survey is restricted to xxxx feet 
to reduce potential effects of barotrauma since the survey was designed as a capture 
and release survey, with a sub-study tag/recapture program. On any given survey day site cells 
are randomly selected within a stratum (MPA and/or reference cells).  Commercial 
passenger fishing vessels (CPFVs) are chartered for the survey and the captain 
is allowed to search within the cell for a fishing location.  During a sampling 
event, each cell is fished for a total of 30-45 minutes by volunteer anglers. Volunteer 
anglers are allowed to reel up their lines when they believe they've hooked fish, 
re-bait and continue fishing until the the drop is complete. Each fish encountered 
can be linked back to an angler. Each anglers fishes one line, with two hooks. 
The jig and bait type may differ.....

All fish encountered are measured to the nearest centimeter (fork length).  
A total of xxxx fish were tagged since 2007, and the majority of fish are 
released or descended to depth. Starting in 2017, at the request of NMFS, some 
fish are retained to collect otoliths and fin clips that provide needed 
biological information for nearshore species.  In 2022, the goal will be to collect 
50-100 otoliths for commonly enountered species for use in the 2023 stock assessments.

Due to the nature of the fishery in northern California, Humboldt conducts sampling aboard 6-pack 
vessels, and therefore has fewer total angler hours per year compared to the 
other regions ().  The COVID-19 pandemic also affect the survey effort, but all 
partners were able to conduct sampling in 2000 and 2001.  





Tables of the number of positive drops of a species by university partner,
inside and outside the MPA

The number of otoliths collected by university partner and year

One sampling iste does not have 



```{r setup, echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, cache = TRUE}
knitr::opts_chunk$set(echo = FALSE)

setwd("C:/GitHub/CCFRP")

#-------------------------------------------------------------------------------
# Read in data and basic cleanup
load("CCFRP_cleanedup.RData")
#-------------------------------------------------------------------------------

Assess2023 <- c('Black rockfish',
                'Copper rockfish',
                'Quillback rockfish', 
                'Yellowtail rockfish')


AssessTop30 <- c('Brown rockfish',
                 'Treefish rockfish',
                 'Blue rockfish',
                 'Deacon rockfish',
                 'Canary rockfish',
                 'Vermilion rockfish',
                 'China rockfish',
                 'Olive rockfish',
                 'Grass rockfish',
                 'Copper rockfish')

#Reorder university so that the table has years in order - not morth to south, 
#but this is a kable issue - if you put HSU first, the first year they sampled, 
#2017, is first in the table
dat <- dat %>%
  mutate(Monitoring.Group = factor(Monitoring.Group, levels = c( "MLML", 
                                                                 "Cal Poly", 
                                                                 "HSU", "BML", 
                                                                 "UCSB", "SIO")))
         
         
#Get the total angler hours by monitoring area
effort_by_program <- dat %>%
  ungroup() %>%
  select(Drift.ID, YEAR, Effort, Total...Anglers.Fishing, Monitoring.Group, Name) %>%
  unique() 

total_effort <- effort_by_program %>%
  select(Monitoring.Group, YEAR, Effort) %>%
  group_by(Monitoring.Group, YEAR) %>%
  summarise(tot_effort = sum(Effort)) %>%
  pivot_wider(names_from = Monitoring.Group, values_from = tot_effort, values_fill = 0)
```



\newpage

```{r anghrs, echo = FALSE, warning = FALSE, message = FALSE}
#Look at the effort by year among the programs
  knitr::kable(booktabs = T,
    caption = "Total angler hours by institution summed across all active years.",
  effort_by_program %>%
  select(Monitoring.Group, YEAR,  Effort) %>%
  group_by(Monitoring.Group, YEAR) %>%
  summarise(Total_AnglerHours = round(sum(Effort),0)) %>%
  pivot_wider(id_cols = YEAR, names_from = Monitoring.Group, values_from = Total_AnglerHours, values_fill = 0)
  ) %>%
    kable_styling(latex_options = "striped")

```




```{r echo = FALSE, include = FALSE, warning = FALSE, message = FALSE}
## Get it down to the species there would be enough or or we're interested in
total.fish <- dat %>%
  group_by(Common.Name) %>%
  summarise(total = sum(n))


dat <- dat %>%
  filter(Common.Name %in% total.fish$Common.Name)

fish_numbers <- dat %>%
  group_by(Common.Name, Monitoring.Group, YEAR, Region) %>%
  summarise(total_fish = sum(n),
            avg_annual_cpue = mean(CPUE))# %>%
  # group_by(Common.Name, CA_area) %>%
  # summarise(avg_fish = mean(total_fish),
  #           avg_cpue = mean(avg_annual_cpue)) %>%
  # mutate(avg_fish = round(avg_fish,0))
  # 

```

\FloatBarrier

\clearpage
\newpage

```{r specieslong, echo = FALSE, warning = FALSE, message = FALSE}
kableExtra::kbl(fish_numbers,
                longtable = TRUE,
  booktabs = TRUE,
  caption = "Longer table with raw data",
  row.names = F
) %>%
  kable_styling(latex_options=c("repeat_header", "striped", "hold_position"))
```